<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<meta name="google-site-verification" content="eaUMXvNaTlS5XY6VQbEb2OQ9XI-jGDm0VQvmNHMz5qI">
<meta name="baidu-site-verification" content="8GfnZRBeT5">








<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="https://fonts.cat.net/css?family=Roboto Slab:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="操作系统,">










<meta name="description" content="异常控制和进程">
<meta name="keywords" content="操作系统">
<meta property="og:type" content="article">
<meta property="og:title" content="异常控制">
<meta property="og:url" content="https://whitneylu.github.io/2019/04/10/异常控制和进程/index.html">
<meta property="og:site_name" content="Whitney&#39;s coding note">
<meta property="og:description" content="异常控制和进程">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://whitneylu.github.io/image/异常类别.png">
<meta property="og:image" content="https://whitneylu.github.io/image/x86-64异常示例.png">
<meta property="og:image" content="https://whitneylu.github.io/image/进程地址空间.png">
<meta property="og:image" content="https://whitneylu.github.io/image/options常量组合.png">
<meta property="og:image" content="https://whitneylu.github.io/image/status参数的几个宏.png">
<meta property="og:image" content="https://whitneylu.github.io/image/参数列表.png">
<meta property="og:image" content="https://whitneylu.github.io/image/用户栈典型组织结构.jpg">
<meta property="og:image" content="https://whitneylu.github.io/image/程序图8-41.png">
<meta property="og:image" content="https://whitneylu.github.io/image/程序图8-43.jpg">
<meta property="og:image" content="https://whitneylu.github.io/image/用信号和非本地跳转来实现软重启.jpg">
<meta property="og:updated_time" content="2019-06-02T07:54:45.974Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="异常控制">
<meta name="twitter:description" content="异常控制和进程">
<meta name="twitter:image" content="https://whitneylu.github.io/image/异常类别.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://whitneylu.github.io/2019/04/10/异常控制和进程/">





  <title>异常控制 | Whitney's coding note</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Whitney's coding note</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Study as if you were going to live forever.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://whitneylu.github.io/2019/04/10/异常控制和进程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="WhitneyLu">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/nessa.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Whitney's coding note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">异常控制</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-10T00:00:00+08:00">
                2019-04-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/异常控制和进程/" itemprop="url" rel="index">
                    <span itemprop="name">异常控制和进程</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  5.5k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  19
                </span>
              
            </div>
          

          
              <div class="post-description">
                  异常控制和进程
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="异常控制和进程"><a href="#异常控制和进程" class="headerlink" title="异常控制和进程"></a>异常控制和进程</h2><h4 id="异常控制流"><a href="#异常控制流" class="headerlink" title="异常控制流"></a>异常控制流</h4><ol>
<li>ak是某个指令Ik的地址，每次从ak到ak+1的过渡称为控制转移，这样的控制转移序列叫做处理器的<strong>控制流</strong></li>
<li>Ik和Ik+1在内存中是相邻的，这种最简单的控制流是”平滑的序列”，<strong>平滑流的突变</strong>通常是跳转、调用和返回造成的</li>
<li>现代系统通过使控制流发生突变来应对系统的突变，将这些突变称为<strong>异常控制流</strong>(Exceptional Control Flow,ECF)。异常控制流发生在计算机系统的各个层次，ECF是操作系统用来实现I/O、进程和虚拟内存的基本机制</li>
<li>应用程序通过使用陷阱或者系统调用的ECF形式，向操作系统请求服务，操作系统为应用程序提供了强大的ECF机制，用来创建新进程、等待进程终止、通知其他进程系统的异常事件以及检测和响应这些事件</li>
<li>ECF是计算机实现并发的基本机制</li>
<li>异常发生于硬件和操作系统交界的部分，进程和信号位于应用和操作系统的交界处，非本地跳转是ECF应用层形式</li>
</ol>
<h3 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h3><ol>
<li>处理器检测到有事情发生时，通过一张交错异常表的跳转表，进行<strong>间接过程调用</strong>，到一个专门用来处理这类程序的操作系统子程序（<strong>异常处理程序</strong>），异常处理程序完成后根据引起异常的数据类型，发生以下3中情况的一种：</li>
</ol>
<ul>
<li>处理程序将控制返回给当前指令</li>
<li>处理程序将控制返回给当前指令的下一条指令</li>
<li>处理程序终止</li>
</ul>
<ol start="2">
<li><strong>异常处理</strong></li>
</ol>
<ul>
<li>系统为每个类型的异常都分配一个唯一的非负整数异常号，系统启动后操作系统分配和初始化一张称为异常表的跳转表，条目k包含异常k的处理程序的地址，异常表的起始地址放在一个叫做异常表基址寄存器的特殊CPU寄存器中</li>
<li>异常程序处理程序运行在内核模式下，它们对所有系统资源都有访问权限</li>
</ul>
<ol start="3">
<li><strong>异常的类别</strong><br>异常可分为四类：终端、陷阱、故障和终止<br><img src="/image/异常类别.png" alt></li>
</ol>
<ul>
<li>硬件中断的异常处理程序称为中断处理程序。剩下三种异常是同步的，是执行当前指令的结果，我们把这类指令叫做<strong>故障指令</strong></li>
<li>陷阱最重要的用途是在用户程序和内核之间提供一种像过程一样接口，称为<strong>系统调用</strong>。用户请求服务n时，执行<code>syscall n</code>，导致一个到异常处理程序的陷阱。</li>
<li>普通函数运行在<strong>用户模式</strong>中，用户模式限制了函数可执行的指令的类型，只能访问和调用函数相同的栈</li>
<li>系统调用运行在<strong>内核模式</strong>中，允许调用执行特权指令，访问内核中的栈</li>
<li>故障由错误的情况引起，可能被故障处理程序修正。故障发生时，处理器将控制转移给故障处理程序。如果能够处理和这个错误，将控制返回到引起故障的指令，重新执行。否则，处理程序返回内核的例程，终止引起故障的程序。</li>
<li>终止是不可恢复的致命错误造成的结果，通常是一些硬件错误，DRAM或者SRAM位损坏发生的奇偶错误，处理程序将控制返回给一个abort例程，终止程序</li>
</ul>
<ol start="4">
<li>Linux/x86-64系统中的异常</li>
</ol>
<ul>
<li>x86-64有256中不同的异常类型，0-31是Intel架构师定义的异常，32-255对应的是操作系统定义的终端和陷阱<br><img src="/image/x86-64异常示例.png" alt></li>
<li>C程序syscall函数可以直接调用任何系统调用，但是一般使用系统调用和相关联的包装函数统称为系统级函数</li>
<li>Linux系统调用的参数一般都通过寄存器而不是栈传递。%rax包含系统调用，%rdi、%rsi、%rdx、%r10、%r9、%r8分别包含第1-6个参数，从系统调用返回时，寄存器%rcx和%r11会被破坏，%rax包含返回值(-4095到-1表示发生错误，对应负值的errno)</li>
</ul>
<h3 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h3><ol>
<li>异常是操作系统允许内核提供进程概念的基本构造块</li>
<li><strong>进程</strong>是执行中的程序的实例，系统中的每个程序都运行在某个进程的上下文中，上下文由程序正确运行所需的状态组成。这个状态包括内存中程序的代码和数据，栈、通用目的寄存器的内容、程序计数器、环境变量以及打开文件描述符的集合</li>
<li>进程提供给应用程序的关键抽象：</li>
</ol>
<ul>
<li>一个独立的逻辑控制流</li>
<li>一个私有的地址空间</li>
</ul>
<ol start="4">
<li>PC值序列称为逻辑控制流(<strong>逻辑流</strong>），一个逻辑流的执行在时间上与另一个流重叠，称为<strong>并发流</strong>，一个进程和其他进程轮流运行的概念称为<strong>多任务</strong>，一个进程执行它的控制流一部分的每一个时间段称为<strong>时间片</strong>，多任务也叫<strong>时间分片</strong>，两个流并发的运行在不同的处理器核或者计算机上，称它们为<strong>并行流</strong></li>
<li>进程为每个程序提供<strong>私有地址空间</strong>，空间中某个地址相关联的内存字节不能被其他进程读或者写<br><img src="/image/进程地址空间.png" alt></li>
<li>处理器通常使用控制寄存器的一个模式位来限制进程当前享有的特权</li>
</ol>
<ul>
<li>设置了模式位时，进程运行在内核模式，可以执行指令集中的任何指令，可以访问系统中的任何内存位置</li>
<li>没有设置模式位，进程运行在用户模式中，进程不允许执行特权指令，必须通过系统调用接口间接地访问内核代码和数据</li>
</ul>
<ol start="7">
<li>Linux提供了/proc文件系统，允许用户模式进程访问内核数据结构的内容。/proc文件系统将内核数据结构的内容输出为用户可读的文本层次结构，2.6版本的Linux引入了/sys文件系统，输出关系系统总线和设备的低层信息</li>
<li><strong>上下文切换</strong>是一种较高层形式的异常控制流，可以实现多任务。内核为每个内存维持一个上下文，上下文就是内核重新启动一个被抢占的进程所需的状态，包括通用目的寄存器、浮点寄存器、程序计数器、用户栈、状态寄存器、内核栈和各种内核数据结构(如，地址空间的页表、包含当前进程信息的进程表、进程已打开文件的信息的文件表)</li>
<li><strong>上下文切换：</strong> </li>
</ol>
<ul>
<li>保存当前进程的上下文</li>
<li>恢复先前被抢占的进程的上下文</li>
<li>将控制转移给这个新恢复的进程</li>
</ul>
<h4 id="进程控制"><a href="#进程控制" class="headerlink" title="进程控制"></a>进程控制</h4><ol>
<li>进程有唯一的进程ID(整数)，getpid函数返回进程的PID</li>
<li>进程的三个状态：</li>
</ol>
<ul>
<li><strong>运行</strong>，在CPU上执行或者等待被执行且最终被调度</li>
<li><strong>停止</strong>，进程被挂起，且不会被调度，<strong>停止信号</strong>SIGSTOP/SIGTSTP/SIGTTIN/SIGTTOU，<strong>再次开始信号</strong>SIGCONT</li>
<li><strong>终止</strong>，进程永远终止，收到信号的默认行为是终止进程、从主程序返回、调用exit函数（exit是以status退出状态来终止进程的）</li>
</ul>
<ol start="3">
<li><strong>父进程</strong>调用<strong>fork函数</strong>来创建一个新的运行的<strong>子进程</strong>，<strong>两者的PID不同</strong></li>
</ol>
<ul>
<li>子进程得到与父进程用户级虚拟地址空间相同的但独立的一个副本，包括代码和数据段、堆、共享库以及用户栈</li>
<li>子进程还获得与父进程任何打开文件描述符相同的副本，子进程可以读写父进程打开的任何文件</li>
</ul>
<ol start="4">
<li>每个进程都只属于一个进程组，进程组由一个正整数进程组ID来标识，<code>getpgrp</code>函数返回当前进程的进程组ID</li>
</ol>
<ul>
<li>子进程和父进程同属于一个进程组</li>
<li>一个进程可以通过使用<code>setpgid</code>函数来改变自己或其他进程的进程组ID<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#include&lt;unistd.h&gt;</span><br><span class="line">int setpgid(pid_t pid,pid_t pgid);</span><br><span class="line">//将进程组pid改成pgid</span><br><span class="line">//如果pid为0，则使用当前进程的PID</span><br><span class="line">//如果pgid为0，用pid指定的进程PID作为进程组ID</span><br><span class="line">setpgid(0,0);//创建一个新的进程组ID15213（调用进程），并且进程15213加入这个新的进程组中</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ol start="5">
<li>父进程和子进程的异同点</li>
</ol>
<ul>
<li>fork被<strong>调用一次会返回两次</strong>，一次在父进程中返回子进程的PID，另一次在子进程中返回0</li>
<li>调用fork，父进程和子进程是<strong>并发运行</strong>的独立进程</li>
<li>在两个进程均没有发生改变之前，父进程和子进程<strong>有相同但独立的地址空间</strong></li>
<li>子进程和父进程<strong>共享文件</strong></li>
</ul>
<ol start="6">
<li>回收子进程</li>
</ol>
<ul>
<li>子进程退出但未被回收的状态被称为<strong>僵死过程</strong></li>
<li>父进程终止子进程的过程：内核将子进程的退出状态传递给父进程，抛弃已终止的进程</li>
<li>如果父进程终止了，内存会安排init进程成为它的孤儿进程的养父，init进程的PID为1，是所有进程的祖先。进程可以通过<strong>waitpid函数</strong>来等待子进程终止或停止<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;sys/types.h&gt;</span><br><span class="line">#include &lt;sys/wait.h&gt;</span><br><span class="line"></span><br><span class="line">pid_t waitpid(pid_t pid,int *statusp,int options);</span><br><span class="line">/*默认情况下（options=0），waitpid函数挂起调用进程的执行，直到等待集合中的一个子进程终止，返回子进程的PID*/</span><br><span class="line">/*判断等待集合的成员：1）pid&gt;0等待集合就是一个单独的子进程，进程ID=pid；2）pid=-1，等待集合是由父进程的所有子进程组成的*/</span><br><span class="line">/*通过将option设为常量WNOHANG/WUNTRACED/WCONTINUED的各种组合来修改默认行为*/</span><br><span class="line">/*如果statusp参数是非空的，waitpid就会在status中放上关于导致返回子进程的状态信息，status就是指向statusp的值*/</span><br><span class="line">/*wait.h头文件定义了status参数的几个宏*/</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>options常量组合<br><img src="/image/options常量组合.png" alt><br>status参数的几个宏<br><img src="/image/status参数的几个宏.png" alt></p>
<ol start="7">
<li><strong>错误条件</strong></li>
</ol>
<ul>
<li>如果调用进程没有子进程，waitpid返回-1，并设置errno为ECHILD</li>
<li>如果waitpid函数被一个信号中断，则返回-1，设置errno为EINTR</li>
</ul>
<ol start="8">
<li><p>让进程休眠</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line"></span><br><span class="line">unsigned int sleep(unsigned int secs);</span><br><span class="line">/*如果请求的时间量到了，sleep返回0，否则返回剩下的秒数*/</span><br><span class="line">/*系统让调用函数休眠，直到该进程收到一个信号*/</span><br><span class="line"></span><br><span class="line">int pause(void);</span><br></pre></td></tr></table></figure>
</li>
<li><p>加载并运行程序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">int execve(const char *filename,const char *argv[],const char *envp[]);</span><br><span class="line">/*execve函数在当前进程的上下文加载并运行一个新程序,如果成功则不返回，如果错误则返回-1*/</span><br><span class="line">/*参数变量表argv和环境变量表envp</span><br><span class="line">argv指向一个以null为结尾的指针数组，每个指针都指向一个参数字符串，argv[0]是可执行目标文件的名字</span><br><span class="line">envp变量指向一个以null为结尾的指针数组，每个指针指向一个环境变量，每个串形如&quot;name=value&quot;的名字值对</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="/image/参数列表.png" alt><br><img src="/image/用户栈典型组织结构.jpg" alt><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">int main(argc,char **argv,char **envp);</span><br><span class="line">//main函数的三个参数</span><br><span class="line">//argc给出argv[]数组中非空指针的数量，argv指向argc[]数组中的第一个条目，envp指向encp[]数组中的第一个条目</span><br><span class="line"></span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">char *getenv(const char *name);</span><br><span class="line">//getenv函数在环境数组中搜索字符串，如果找到就返回value的指针，否则返回NULL</span><br><span class="line"></span><br><span class="line">//如果环境数组包含一个形如“name=oldvalue”的字符串</span><br><span class="line">int setenv(const char *name,const char *newvalue,int overwrite);</span><br><span class="line">//用newvalue代替oldvalue，只有overwrite非零时才会这样，如果name不存在，将“name=oldvalue”添加到数组中</span><br><span class="line">void unsetenv(const char *char);//删除字符串</span><br></pre></td></tr></table></figure></p>
<ol start="10">
<li>shell执行一系列读/求值，然后终止，读步骤读取来自用户的一个命令行，求值步骤解析命令行，代表<strong>用户运行程序</strong></li>
</ol>
<h3 id="信号"><a href="#信号" class="headerlink" title="信号"></a>信号</h3><ol>
<li>Linux信号是更高层的软件形式的异常，允许进程和内核中断其他进程</li>
<li>每种信号类型都对应于某种系统事件，低层的硬件异常是由内核处理程序处理的，通常对用户进程是不可见的，系统提供了一种机制通知用户发生了这些异常</li>
<li>传送信号到目的进程是由两个不同步骤组成的：</li>
</ol>
<ul>
<li><strong>发送信号</strong>，内核通过更新目的进程上下文中的某个状态，发送一个信号给目的进程，发送信号的两个原因，内核检测到一个系统事件或是一个进程调用了kill函数</li>
<li><strong>接收信号</strong>，目的进程被内核强迫以某种方式对信号的发送做出反应，进程可以忽略这个信号，终止或通过执行一个称为信号处理程序的用户层函数捕获这个信号<br>4.一个发出而没有被接收的信号叫做<strong>待处理信号</strong>，在任何时刻，一种类型至多有一个待处理信号，如果进程有一个待处理信号k，那么接下来所有发送到这个进程的信号k都会被丢弃</li>
</ul>
<ol start="5">
<li>一个进程可以有选择的阻塞接收某种信号，当一种信号被阻塞时，仍可以被发送，但是产生的待处理信号不会被接收。一个待处理信号只能被接收一次，内核为每个进程在pending位向量中维护待处理信号的集合</li>
<li>blocked位中维护者被阻塞的信号集合</li>
</ol>
<h4 id="发送信号"><a href="#发送信号" class="headerlink" title="发送信号"></a>发送信号</h4><ol>
<li>用/bin/kill程序发送信号<br>/bin/kill -9 15213 #发送信号9到进程15213<br>/bin/kill -9 -15213 #一个为负的PID会导致信号被发送到进程组PID中的每个进程</li>
</ol>
<ul>
<li>从键盘发送信号<code>ls | sort</code>#常见由两个进程组成的前台作业，两个进程通过Unix管道连接，一个进程运行ls程序，另一个运行sort程序</li>
<li>shell为每个作业创建一个独立的进程组，进程组ID通常取自作业中父进程中的一个</li>
</ul>
<ol start="2">
<li><p>用kill函数发送信号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;sys/types.h&gt;</span><br><span class="line">#include &lt;signal.h&gt;</span><br><span class="line">int kill(pid_t pid,int sig);</span><br><span class="line">//若pid&gt;0，kill函数发送信号sig给进程pid</span><br><span class="line">//若pid=0，kill函数发送信号sig给调用进程所在进程组的每个进程，包括调动进程自己</span><br><span class="line">//若pid&lt;0，kill函数发送信号sig给进程|pid|中的每个进程</span><br></pre></td></tr></table></figure>
</li>
<li><p>用alarm函数发送信号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">unsinged int alarm(unsigned int secs);</span><br><span class="line">//安排内核在secs秒后发送一个信号给调用进程，如果secs=0，调度不会安排新的闹钟</span><br><span class="line">//在任何情况下，对alarm的调用都会取消任何待处理的（pending）闹钟</span><br><span class="line">//返回任何待处理闹钟在发送前还剩下的秒数</span><br><span class="line">//如果没有任何待处理的闹钟，就返回0</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="接收信号"><a href="#接收信号" class="headerlink" title="接收信号"></a>接收信号</h4><ol>
<li>每个信号都一个预定义的默认行为</li>
</ol>
<ul>
<li>进程终止</li>
<li>进程终止并转储内存</li>
<li>进程停止知道被SIGCONT信号重启</li>
<li>进程忽略该信号</li>
</ul>
<ol start="2">
<li><p><strong>signal信号</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;signal.h&gt;</span><br><span class="line">typedef void (*sighandler_t)(int);</span><br><span class="line">sighandler_t signal(int signum,sighander_t handler);</span><br><span class="line">//signal函数可以通过下列三种方法之一来改变和信号signum相关联的行为</span><br><span class="line">//如果handler是SIG_ING，忽略类型为signum的信号</span><br><span class="line">//如果handler是SIG_DFL，类型为signum的信号行为恢复为默认行为</span><br><span class="line">//否则handler就是用户定义的函数的地址，这个函数被称为信号处理程序</span><br><span class="line">//通过处理程序把地址传递到signal函数而改变默认行为，叫做设置信号处理程序</span><br></pre></td></tr></table></figure>
</li>
<li><p>调用信号处理程序被称为<strong>捕获信号</strong>，执行信号处理程序被称为<strong>处理信号</strong></p>
</li>
<li>进程捕获一个类型为k的信号，会调用信号k设置的信号处理程序，一个整数参数被设置为k，这个参数允许同一个处理函数捕获不同类型的信号</li>
</ol>
<h4 id="阻塞和解除阻塞信号"><a href="#阻塞和解除阻塞信号" class="headerlink" title="阻塞和解除阻塞信号"></a>阻塞和解除阻塞信号</h4><ol>
<li>隐式阻塞机制：内核默认阻塞任何当前处理程序正在处理信号类型的待处理信号</li>
<li><p>显式阻塞机制：应用程序使用sigprocmask函数和它的辅助函数，明确的阻塞和解除阻塞选定的信号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;signal.h&gt;</span><br><span class="line"></span><br><span class="line">int sigprocmask(int how,const sigset_t *set,sigset_t *oldset);</span><br><span class="line">//sigprocmask会改变当前阻塞的信号集合，以来与how值</span><br><span class="line">//SIG_BLOCK：把set中的信号添加到blocked中(block=block|set)</span><br><span class="line">//SIG_UNBLOCK：从block中删除set中的信号(block=block&amp;~set)</span><br><span class="line">//SIG_SETMASK：block=set</span><br><span class="line">//如果oldset非空，那么blocked位向量之前的值保存在oldset中</span><br><span class="line"></span><br><span class="line">int sigemptyset(sigset_t *set);//初始化set为空集合</span><br><span class="line">int sigfillset(sigset_t *set);//把每个信号都添加到set中</span><br><span class="line">int sigaddset(sigset_t *set,int signum);//把signum添加到set中</span><br><span class="line">int sigdelset(sigset_t *set,int signum);//把signum从set中删除</span><br><span class="line">int sigismember(const sigset_t *set,int signum);//如果signum是set成员返回1，否则返回0</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过阻塞信号和取消阻塞信号来避免并发错误</p>
</li>
</ol>
<h4 id="编写信号处理程序"><a href="#编写信号处理程序" class="headerlink" title="编写信号处理程序"></a>编写信号处理程序</h4><ol>
<li>主程序和信号处理程序并发运行，相互干扰</li>
<li>信号处理中产生输出唯一安全的方法是使用write函数，为了绕开这个限制，我们开发了一些安全的函数，称为SIO包，用来在信号处理程序中打印简单的信息<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;csapp.h&quot;</span><br><span class="line">ssize_t sio_putl(long v);//向标准输出传送long类型数</span><br><span class="line">ssize_t sio_puts(char s[]);//向标准输出传送字符串</span><br><span class="line"></span><br><span class="line">void sio_error(char s[]);//打印一条错误信息并终止</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ul>
<li>处理程序尽可能的简单</li>
<li>在处理程序中只调用异步信号安全的函数，是可重入的或者不能被信号处理程序终端</li>
<li>保存和恢复errno，在进入处理程序时将errno保存在一个局部变量中，在处理程序返回时恢复它</li>
<li>阻塞所有信号，保护对共享全局数据结构的访问，保证处理程序不会中断指令</li>
<li>用volatile生声明全局变量，强迫编译器每次在代码中引用g时都要从内存中读取g的值</li>
<li>用sig_atomic_t声明标志，保证读和写是原子的（不可中断的），<code>volatile sig_atomic_t flag;</code></li>
</ul>
<ol start="3">
<li>正确的信号处理，不可以用信号对其他进程中发生的之间计数，相同类型的信号可能会丢失</li>
<li>可移植的信号处理：1）不同的系统有不同的信号处理语义；2）系统调用可以被中断</li>
<li>Posix标准定义了sigaction函数，允许用户设置信号处理时明确指定他们想要的信号处理语义<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;signal.h&gt;</span><br><span class="line">int sigaction(int signum,struct sigaction *act,struct sigaction *oldact);</span><br><span class="line">//一个更简洁的方式，用Signal包装函数调用sigaction</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>Signal包装函数设置了一个信号处理程序，其信号处理语义如下：</p>
<ul>
<li>只有这个处理程序当前正在处理的那种类型的信号被阻塞</li>
<li>信号不会排队的等待</li>
<li>中断的系统调用会自动重启</li>
<li>一旦设置了信号处理程序，会一直被保持，直到Signal带着handler参数为SIG_IGN或者SIG_DFL被调用</li>
</ul>
<ol start="6">
<li><strong>显式的等待信号</strong><br><img src="/image/程序图8-41.png" alt></li>
</ol>
<ul>
<li>父进程设置SIGINT和SIGCHLD的处理程序，然后进入一个无限循环</li>
<li>阻塞了SIGCHLD信号，避免了竞争</li>
<li>创建了子进程之后，将pid设为0，取消阻塞SIGCHLD，然后以循环的方式等待pid变为非零</li>
<li>子进程终止后，处理程序回收它，以非零的PID赋值给全局pid变量，终止循环，父进程开始其他工作，然后开始下一次迭代</li>
<li>使用sigsuspend，修补循环造成的浪费资源<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;signal.h&gt;</span><br><span class="line">int sigsuspend(const sigset_t *mask);</span><br><span class="line">//暂时用mask替换当前的阻塞集合，然后挂起该进程，直到收到一个信号</span><br><span class="line">//如果信号的行为是终止的，那么sigsuspend从处理程序返回</span><br><span class="line">//如果信号的行为是运行一个处理程序，sigsuspend从处理程序返回，恢复调用sigsuspend时原有的阻塞集合</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="非本地跳转"><a href="#非本地跳转" class="headerlink" title="非本地跳转"></a>非本地跳转</h4><ol>
<li>将控制直接从一个函数转移到当前正在执行的函数，而不需要经过正常调用-返回序列，通过setjmp和longjmp函数来提供的</li>
<li>非本地跳转允许从一个深层嵌套的函数调用中立即返回，通常是检测到某个错误情况引起的<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;setjmp.h&gt;</span><br><span class="line">int setjmp(jmp_buf env);</span><br><span class="line">//在env缓冲区中保存当前调用环境，供后面的longjmp使用，返回0，stejmp返回的值不能被赋值给变量</span><br><span class="line">//调用环境包括程序计数器、栈指针和通用目的寄存器</span><br><span class="line">int sigsetjmp(sigjmp_buf env,int savesigs);</span><br><span class="line"></span><br><span class="line">void longjmp(jmp_buf env,int retval);</span><br><span class="line">void siglongjmp(sigjmp_buf env,int retval);</span><br><span class="line">//longjmp函数从env缓冲区中恢复调用环境，触发从最近一次初始化env的setjmp调用的返回，然后setjmp返回并带有非零的返回值retval</span><br><span class="line">//setjmp调用一次，但是返回多次；longjmp调用一次，但是从不返回</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="/image/程序图8-43.jpg" alt><br><img src="/image/用信号和非本地跳转来实现软重启.jpg" alt></p>
<h4 id="操作进程的工具"><a href="#操作进程的工具" class="headerlink" title="操作进程的工具"></a>操作进程的工具</h4><ul>
<li>STRACE：打印正在运行的程序和子进程调用的每个系统调用的轨迹，用<code>-strace</code>编译程序</li>
<li>PS：列出当前系统中的进程（包括僵死程序）</li>
<li>TOP：打印出关于当前进程资源使用的信息</li>
<li>PMAP：显示进程的内存映射</li>
<li>/proc：虚拟文件系统，以ASCII文本格式输出大量内核数据</li>
</ul>

      
    </div>
    
    
    

    
      <div>
        <div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="/images/wechat.jpg" alt="WhitneyLu wechat" style="width: 200px; max-width: 100%;">
    <div>Contact me by scanning my public WeChat QR code</div>
</div>


      </div>
    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/操作系统/" rel="tag"><i class="fa fa-tag"></i> 操作系统</a>
          
        </div>
      

      
      
        <div class="post-widgets">
        

        

        
          
          <div id="needsharebutton-postbottom">
            <span class="btn">
              <i class="fa fa-share-alt" aria-hidden="true"></i>
            </span>
          </div>
        
        </div>
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/04/05/链接/" rel="next" title="链接">
                <i class="fa fa-chevron-left"></i> 链接
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/04/10/虚拟内存/" rel="prev" title="虚拟内存">
                虚拟内存 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>

<script type="text/javascript" src="https://me.idealli.com/images/load.gif" data-src="/js/src/love.js"></script>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/nessa.png" alt="WhitneyLu">
            
              <p class="site-author-name" itemprop="name">WhitneyLu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">37</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">27</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/yourname" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:miracle960118@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.instagram.com" target="_blank" title="Instagram">
                      
                        <i class="fa fa-fw fa-instagram"></i></a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#异常控制和进程"><span class="nav-number">1.</span> <span class="nav-text">异常控制和进程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#异常控制流"><span class="nav-number">1.0.1.</span> <span class="nav-text">异常控制流</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#异常"><span class="nav-number">1.1.</span> <span class="nav-text">异常</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#进程"><span class="nav-number">1.2.</span> <span class="nav-text">进程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#进程控制"><span class="nav-number">1.2.1.</span> <span class="nav-text">进程控制</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#信号"><span class="nav-number">1.3.</span> <span class="nav-text">信号</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#发送信号"><span class="nav-number">1.3.1.</span> <span class="nav-text">发送信号</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#接收信号"><span class="nav-number">1.3.2.</span> <span class="nav-text">接收信号</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#阻塞和解除阻塞信号"><span class="nav-number">1.3.3.</span> <span class="nav-text">阻塞和解除阻塞信号</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编写信号处理程序"><span class="nav-number">1.3.4.</span> <span class="nav-text">编写信号处理程序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#非本地跳转"><span class="nav-number">1.3.5.</span> <span class="nav-text">非本地跳转</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#操作进程的工具"><span class="nav-number">1.3.6.</span> <span class="nav-text">操作进程的工具</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 &mdash; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-Whitney"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">WhitneyLu</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">79.9k</span>
  
</div>







        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    
      <div id="needsharebutton-float">
        <span class="btn">
          <i class="fa fa-share-alt" aria-hidden="true"></i>
        </span>
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">

  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "default";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
      flOptions = {};
      
          flOptions.iconStyle = "default";
      
          flOptions.boxForm = "vertical";
      
          flOptions.position = "topRight";
      
          flOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-float', flOptions);
    
  </script>

  

  

  

  

</body>
</html>
